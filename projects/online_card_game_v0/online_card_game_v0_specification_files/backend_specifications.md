---
Project: Online Card Game
Type: Specifications
Date: 2025-07-17
Spec-ID: SPEC-CG-BACK
---

# Online Card Game V0 Backend Specifications

## Overview
This document details the technical specifications for the backend of the Online Card Game V0, corresponding to **SPEC-CG-BACK** from **4.4.2 Online_Card_Game_Specifications_Overview.md**. The backend provides API endpoints for multiplayer game logic and AI-driven educational challenges, supporting requirements FR01 (multiplayer gameplay), FR02 (AI-driven challenges), and NFR04 (performance). It is designed for solo development within a 20-hour/week schedule, using Python/FastAPI on Linode for lightweight APIs and game server, and Ollama on Proxmox (LXC container `dockProd1`, 1 RTX 5060 Ti GPU, 32 GB RAM) for LLM processing, integrated with the AI-driven website.

## Technical Specifications
- **Technology**: Python/FastAPI for API endpoints and game logic, Ollama for AI-driven challenge generation.
- **Hosting**:
  - FastAPI: Docker container on Linode (4 GB RAM, 2 CPU cores, 80 GB storage, Debian OS).
  - Ollama: LXC container `dockProd1` on Proxmox, allocated 1 RTX 5060 Ti GPU, 32 GB RAM.
- **Configuration**:
  - FastAPI server (`main.py`):
    ```python
    from fastapi import FastAPI, WebSocket
    from pydantic import BaseModel
    import ollama
    import json

    app = FastAPI()

    class GameAction(BaseModel):
        game_id: str
        player_id: str
        action: str  # e.g., "draw", "play_card", "discard"
        card_id: str = None

    class ChallengeRequest(BaseModel):
        game_id: str
        player_id: str
        challenge_type: str

    @app.websocket("/ws/game/{game_id}")
    async def websocket_game(websocket: WebSocket, game_id: str):
        await websocket.accept()
        while True:
            data = await websocket.receive_text()
            action = json.loads(data)
            # Update game state in PostgreSQL
            # Broadcast updates to players
            await websocket.send_text(json.dumps({"status": "updated", "game_id": game_id}))

    @app.post("/api/game/challenges")
    async def generate_challenge(request: ChallengeRequest):
        response = ollama.chat(
            model="llama3",
            messages=[{"role": "user", "content": f"Generate {request.challenge_type} AI/ML challenge for game {request.game_id}"}],
            context={"player_id": request.player_id}
        )
        return {"challenge": response["message"]["content"]}
    ```
  - Ollama: Configured with fine-tuned `llama3` model, RAG pipeline using PostgreSQL embeddings for context-aware challenge generation.
  - API endpoints proxied via Nginx (`/api/game/`), secured by Cloudflare Tunnel.
- **Features**:
  - WebSocket endpoint (`/ws/game/{game_id}`) handles real-time multiplayer actions (draw, play, discard) for 2-4 players (FR01).
  - Challenge endpoint (`/api/game/challenges`) generates AI/ML-themed challenges (e.g., neural network Q&A, coding tasks) (FR02).
  - Session management links actions to game sessions in PostgreSQL (NFR04).
- **Performance**: API responses <1s for 95% of game actions, supporting 10 concurrent players (NFR04).

## Implementation Details
- **Development**: Code FastAPI in VS Code, push to Git on Proxmox, deploy via Docker on Linode.
- **RAG Pipeline**: Game logs and markdown documents parsed by Python script, embeddings generated by Ollama, stored in PostgreSQL (`rag_embeddings` table).
  - Example query: `SELECT document_path FROM rag_embeddings ORDER BY embedding <=> ollama_embed(challenge_query) LIMIT 3`.
- **Testing**: Test game logic and Ollama in `dockTest1` (Proxmox) for accuracy, validate APIs on Linode for latency and concurrency.
- **Deployment**: FastAPI and game server deployed via `docker-compose` on Linode; Ollama in `dockProd1` with GPU passthrough, updated via n8n.
- **Dependencies**: Requires AI-driven website (Nginx, Cloudflare) for integration, PostgreSQL (`dockProd2`) for data storage.

## RAG Integration
- **Usage**: Feeds into Meeting Roomâ€™s RAG pipeline for planning and challenge content generation.
- **Structure**: Consistent headers, code snippets, and metadata for parseability.
- **Storage**: Store in `/docs/projects/online_card_game_specifications/`, sync to Linode, embed in PostgreSQL for RAG queries.